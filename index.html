<html>
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.css" integrity="sha256-5+W3JHnvGYIJkVxUBsw+jBi9+pOlu9enPX3vZapXj5M="
        crossorigin="anonymous" />
    <script src="p5.min.js"></script>
    <script src="p5.dom.js"></script>
</head>
<body bgcolor="#000000">
    <button id="ledbutton" onmousedown="drawLEDs()">Draw LEDs</button>
    <button id="wirebutton" onmousedown="drawWires()">Draw wires</button>
    <button id="clearbutton" onmousedown="clear()">Clear</button>
    <button id="savebutton" onmousedown="saveTest()">Save</button>

    <script>
        /* start of p5js stuff */
        var rectsize = 12;
        var drawingLeds = false;
        var drawingWires = false;
        var connectingleds = false;
        var firstled = null;
        var selectedLED = null;
        var prevSelectedLED = null;
        var LEDs = [];
        var wires = [];

        /* one time setup funtion */
        function setup() {
            createCanvas(640, 480);
            stroke(0);
        }

        /* draw loop */
        function draw() {
            background(255);
            for (var i = 0; i < LEDs.length; i++)
                LEDs[i].draw();
            for (var i = 0; i < wires.length; i++)
                wires[i].draw();
        }

        /* button event for clicking draw LEDs button */
        function drawLEDs() { 
            drawingLeds = true;
            drawingWires = false;
            console.log(document.getElementById("ledbutton").style.border);
            document.getElementById("ledbutton").style.border = "thick solid #FFFF00";
            document.getElementById("wirebutton").style.border = "";
        }

        /* button event for clicking draw wires button */
        function drawWires() { 
            drawingWires = true;
            drawingLeds = false;
            document.getElementById("ledbutton").style.border = "";
            document.getElementById("wirebutton").style.border = "solid #FFFF00";
        }

        /* */
        function Wire(led1, led2) {
            this.led1 = led1;
            this.led2 = led2;
            this.led1.nextLED = led2;
            this.led2.prevLED = led1;

            this.draw = function() {
                line(this.led1.x, this.led1.y, this.led2.x, this.led2.y);
            }
        }

        /* */
        function LED(x, y) {
            this.x = x;
            this.y = y;
            this.leftEdge = this.x - (rectsize/2);
            this.rightEdge = this.x + (rectsize/2);
            this.topEdge = this.y - (rectsize/2);
            this.bottomEdge = this.y + (rectsize/2);
            this.prevLED = null;
            this.nextLED = null;
            this.selected = false;
            this.color = color(255, 255, 0);
            this.group = 0;

            this.draw = function() {
                if (this.isSelected()) {
                    stroke(255, 150, 0);
                    fill(255, 150, 0);
                    rect(this.leftEdge-2, this.topEdge-2, rectsize+4, rectsize+4);
                    stroke(0);
                    fill(this.color); // main inside LED color
                    rect(this.leftEdge, this.topEdge, rectsize, rectsize);
                }
                else {
                    rect(this.leftEdge, this.topEdge, rectsize, rectsize);
                }
            }

            this.clicked = function() {
                if ((mouseX >= this.leftEdge) && (mouseX <= this.rightEdge) && (mouseY >= this.topEdge) && (mouseY <= this.bottomEdge)){
                    this.selected = true;
                    return true;
                }
                this.selected = false;
                return false;
            }

            this.isSelected = function() {
                return this.selected;
            }

            this.setNextLED = function(led) {
                this.nextLED = led;
            }

            this.setPrevLED = function(led) {
                this.prevLED = led;
            }
        }

        function mouseClicked() {
            if (drawingLeds){
                fill(255, 255, 0);
                var led = new LED(mouseX, mouseY);
                LEDs.push(led);
            } else if (drawingWires) {
                var noselectedLEDs = true;
                for (var i = 0; i < LEDs.length; i++){
                    if (LEDs[i].clicked()){
                        if (selectedLED){
                            prevSelectedLED = selectedLED;
                            selectedLED = LEDs[i];
                            if (prevSelectedLED != selectedLED){
                                checkExistingWiring(prevSelectedLED, selectedLED);
                            }
                        }
                        selectedLED = LEDs[i];
                        noselectedLEDs = false;
                    }
                }
                if (noselectedLEDs == true){
                    selectedLED = null;
                    prevSelectedLED = null;
                }
            }  
        }    

        /* Checks the wiring configuration (if any) between 2 LEDs */
        function checkExistingWiring(ledClicked1, ledClicked2){
            // if switching next led of an led
            if (ledClicked1.nextLED && ledClicked1.nextLED != ledClicked2){
                for (var i = 0; i < wires.length; i++){
                    if (wires[i].led1 == ledClicked1){
                        wires.splice(i, 1);
                    }
                }         
            }
            // if both leds have been previously wired the opposite way
            else if (ledClicked1.prevLED == ledClicked2 && ledClicked2.nextLED == ledClicked1){
                for (var i = 0; i < wires.length; i++){
                    if (wires[i].led2 == ledClicked1 && wires[i].led1 == ledClicked2){
                        ledClicked1.prevLED = null;
                        ledClicked2.nextLED = null;
                        wires.splice(i, 1);

                    }
                } 
            }
            // if both leds are wired the same way
            else if (ledClicked2.prevLED == ledClicked1 && ledClicked1.nextLED == ledClicked2){
                for (var i = 0; i < wires.length; i++){
                    if (wires[i].led1 == firstled && wires[i].led2 == led){
                        wires.splice(i, 1);
                    }
                }
            }
            var wire = new Wire(prevSelectedLED, selectedLED);
            wires.push(wire);
        }

        /* button event for clicking clear */
        function clear() {
            if (confirm("Are you sure you want to start over?")) {
                LEDs = [];
                wires = [];
            }
        }

        /* button event for clicking save */
        function saveTest() {
            console.log("in save test");
            saveUserCode("test", "test");
        }

        /* end of p5js stuff */

        /* start of iframe communication stuff */

        var extId = window.location.hash.substr(1);
        var hosted = false;
        var idToType = {};
        var usercode = {};

        console.log(`extension id: ${this.extId}`)
        window.addEventListener(
            "message",
            ev => ev.data.type == "pxtpkgext" ? receiveMessage(ev.data) : undefined,
            false);
        sendRequest("extinit");
        

        /*function receiveMessage(ev) {
            var msg = ev.data;
            var action = idToType[msg.id];
            if (action) {
                console.debug('neopixel layout received ' + action);
                switch (action) {
                    case "extinit":
                        hosted = true;
                        console.log('host connection completed')
                        sendRequest("extreadusercode");
                        break;
                    case "extreadusercode":
                        usercode = msg.resp || {};
                        break;
                }
                delete idToType[msg.id];
            }
        }*/

    function receiveMessage(ev) {
        if (ev.event) {
            switch (ev.event) {
                case "extconsole":
                    var cons = ev;
                    // drop sim
                    if (cons.body.sim) return;
                    break;
                case "extshown":
                    console.log('shown')
                    //connected = true;
                    this.sendRequest("extdatastream");
                    this.sendRequest("extreadcode")
                    break;
                case "exthidden":
                    console.log('hidden')
                    //connected = false;
                    break;
                default:
                    break;
            }
            return;
        }

        var action = idToType[ev.id];
        console.log(`msg: ${action}`)
        delete idToType[ev.id];
        switch (action) {
            case "extinit":
                sendRequest("extdatastream");
                sendRequest("extreadcode");
                break;
            case "extreadcode":
                // received existing code
                var usercode = data;
                //loadBlocks(usercode.resp.code, usercode.resp.json);
                break;
            default: break;
        }
    }


        function isIFrame() {
            try {
                return window && window.self !== window.top;
            } catch (e) {
                return true;
            }
        }


        function sendRequest(action, body=null) {
            var id = Math.random().toString();
            idToType[id] = action;
            var msg = {
                type: "pxtpkgext",
                action: action,
                extId: extId,
                response: true,
                id: id,
                body
            };
            if (window.parent && window != window.parent)
                window.parent.postMessage(msg, "*");
        }


        function renderUserCode() {
            console.log("render code function");
            var ts = `
namespace layoutdesigner {

    /*
    * A neopixel layout
    */
    //% blockId="testblock" block="stubtest2 %num"   
    export function testing(num: number): number {
        return num;
    }
}` 
            return ts;
        }

        function saveUserCode(fileName, out) {            
            usercode[fileName.toLowerCase()] = out;
            var ts = renderUserCode();
            sendRequest("extwritecode", {
                code: ts,
                json: JSON.stringify(usercode, null, 2)
            });
            preview.innerText = 'Layout saved...';
            output.innerText = ts;
            outputext.style.display = 'block';
            console.log("save function");
        }

        /* onload functions, send initialized message back to editor */
        /*document.onreadystatechange = function (er) {
            if (document.readyState != "complete") return;

            window.addEventListener("message", receiveMessage, false);
            sendRequest("extinit")
        }*/

        /* end of iframe communication stuff */
 
    </script>
</body>
</html>